# Stage 1: Build Trivy
FROM aquasec/trivy:latest as trivy

# Use the latest Alpine image with Python
FROM python:3.14.0a2-alpine3.20

# Set environment variable for Flask
ENV FLASK_APP=flaskr

# Install Python and pip
# This indicates that the image is based on Alpine and includes Python
RUN apk add --no-cache python3 py3-pip

# Copy Trivy from the first stage
COPY --from=trivy /usr/local/bin/trivy /usr/local/bin/trivy

# Set the working directory
WORKDIR /app

# Copy the application files
COPY . /app

# Install dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Run Trivy to analyze the image and output results to a JSON file
RUN trivy image --output cve_analysis_results.json python:3.14.0a2-alpine3.20

# Expose the port the app runs on
EXPOSE 5000

# Define the command to run the application
# CMD ["python3", "run.py"]
CMD ["flask", "run", "--host=0.0.0.0", "--port=5000"]
